[extruder]
step_pin: P2.3
dir_pin: P0.22
enable_pin: !P0.21
microsteps: 16
rotation_distance: 7.777
nozzle_diameter: 0.4
filament_diameter: 1.75
heater_pin: P2.7
sensor_type: EPCOS 100K B57560G104F
sensor_pin: P0.23
control: pid
pid_Kp: 13.509
pid_Ki: 0.566
pid_Kd: 80.549
min_temp: -150
max_temp: 320
max_extrude_only_distance: 300.0

[gcode_macro T0]
gcode:
    ACTIVATE_EXTRUDER extruder=extruder

[gcode_macro M109]
rename_existing: M1091
gcode:
    STATUS_LED STATUS=started
    {% set extruder = params.T|default(-1)|int %}
    {% if extruder >= 0 %}
        M1091 T{params.T} S{params.S}
    {% else %}
        M1091 S{params.S}
    {% endif %}
    STATUS_LED STATUS=printing

[gcode_macro INSERT_MATERIAL]
gcode:
    G91
    {% set active_extruder = printer.toolhead.extruder %}
    {% if active_extruder == 'extruder' %}
        G1 E130 F300
    {% elif active_extruder == 'extruder1' %}
        G1 E200 F300
        G1 E200 F1200
        G1 E200 F1200
        G1 E200 F1200
        G1 E200 F1200
        G1 E200 F1200
        G1 E200 F1200
        G1 E200 F300
        G1 E200 F300
    {% endif %}
    G90

[gcode_macro LOAD_MATERIAL]
gcode:
    G91
    G1 E20 F300
    G90

[gcode_macro RETRACT_MATERIAL]
gcode:
    G91
    G1 E-20 F300
    G90

[gcode_macro EJECT_MATERIAL]
gcode:
    G91
    {% set active_extruder = printer.toolhead.extruder %}
    {% if active_extruder == 'extruder' %}
        G1 E-130 F300
    {% elif active_extruder == 'extruder1' %}
        G1 E-200 F300
        G1 E-200 F300
        G1 E-200 F1200
        G1 E-200 F1200
        G1 E-200 F1200
        G1 E-200 F1200
        G1 E-200 F1200
        G1 E-200 F1200
        G1 E-200 F1200
    {% endif %}
    G90

[gcode_macro XY_NOZZLE_OFFSET_PATTERN]
gcode:
    {% set lines = params.LINES|default(21)|int %}
    {% set width = params.WIDTH|default(5.0)|float %}
    {% set step = params.STEP|default(0.1)|float %}
    {% set length = params.LENGTH|default(20.0)|float %}
    {% set height = params.HEIGHT|default(0.3)|float %}
    {% set speed = params.SPEED|default(10.0)|float %}
    {% set line_width = params.LINE_WIDTH|default(0.4)|float %}
    {% set fil_diameter = params.FILDAMENT_DIAMETER|default(1.75)|float %}
    {% set extrusion_ratio = (height * line_width * 4)/(3.14159 * fil_diameter * fil_diameter) %}
    {action_respond_info('extrusion_ratio: %.6f' % extrusion_ratio)}
    {% set middle = (lines - 1) / 2 %}
    {% for index in range(lines) %}
        {% set start_x = 10 if index == 0 else 12 %}
        {% set end_x = 12 + length %}
        {% set y = 10 + index * width %}
        {% set e = (end_x - start_x) * extrusion_ratio * (index + 1) %}
        {action_respond_info('G0 F1200 X%.2f Y%.2f\n' % (start_x, y))}
        {action_respond_info('G1 F%.2f X%.2f E%.3f' % (speed * 60, end_x, e))}
    {% endfor %}
    G92 E0
    {% for index in range(lines) %}
        {% set start_y = 10 if index == 0 else 12 %}
        {% set end_y = 12 + length %}
        {% set x = 60 + index * width %}
        {% set e = (end_y - start_y) * extrusion_ratio * (index + 1) %}
        {action_respond_info('G0 F1200 X%.2f Y%.2f\n' % (x, start_y))}
        {action_respond_info('G1 F%.2f Y%.2f E%.3f' % (speed * 60, end_y, e))}
    {% endfor %}
    G92 E0
    T1
    {% for index in range(lines) %}
        {% set start_x = 13 + length %}
        {% set end_x = start_x + length %}
        {% set y = 10 + index * width + (index - middle) * step %}
        {% set e = (end_x - start_x) * extrusion_ratio * (index + 1) %}
        {action_respond_info('G0 F1200 X%.2f Y%.2f\n' % (start_x, y))}
        {action_respond_info('G1 F%.2f X%.2f E%.3f' % (speed * 60, end_x, e))}
    {% endfor %}
    G92 E0
    {% for index in range(lines) %}
        {% set start_y = 13 + length %}
        {% set end_y = start_y + length %}
        {% set x = 60 + index * width + (index - middle) * step %}
        {% set e = (end_y - start_y) * extrusion_ratio * (index + 1) %}
        {action_respond_info('G0 F1200 X%.2f Y%.2f\n' % (x, start_y))}
        {action_respond_info('G1 F%.2f Y%.2f E%.3f' % (speed * 60, end_y, e))}
    {% endfor %}
